{% extends "base.html" %}

{% block title %}Edit Reimbursement #{{ reimbursement.pk }} | AIM{% endblock %}

{% block content %}
<div class="container py-5">
  <nav class="mb-3">
    <a href="{% url 'reimbursements:my_reimbursements' %}" class="text-decoration-none">
      &larr; Back to My Reimbursements
    </a>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-1">Edit Reimbursement #{{ reimbursement.pk }}</h1>
      {% if reimbursement.enrollment and reimbursement.enrollment.workshop %}
      <p class="text-muted mb-0">{{ reimbursement.enrollment.workshop.title }}</p>
      {% endif %}
    </div>
    <span class="badge bg-secondary fs-6">
      {% if reimbursement.status == 'draft' %}Draft{% elif reimbursement.status == 'changes_needed' %}Changes Needed{% endif %}
    </span>
  </div>

  {% if reimbursement.status == 'changes_needed' and reimbursement.change_request_notes %}
  <div class="alert alert-warning">
    <h5 class="alert-heading">Changes Requested</h5>
    <p class="mb-0">{{ reimbursement.change_request_notes }}</p>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-lg-8">
      {# Expenses Section #}
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Expenses</h5>
          <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
            + Add Expense
          </button>
        </div>
        <div class="card-body p-0">
          {% if reimbursement.line_items.all %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Category</th>
                  <th>Description</th>
                  <th>Date</th>
                  <th class="text-end">Amount</th>
                  <th>Receipts</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for item in reimbursement.line_items.all %}
                <tr>
                  <td>{{ item.get_category_display }}</td>
                  <td>{{ item.description }}</td>
                  <td>{{ item.date_incurred|date:"M j, Y" }}</td>
                  <td class="text-end">${{ item.amount_requested|floatformat:2 }}</td>
                  <td>
                    {% for receipt in item.receipts.all %}
                    <span class="badge bg-light text-dark me-1">
                      <a href="{% url 'reimbursements:protected_receipt' reimbursement.pk item.pk receipt.pk %}" target="_blank" class="text-decoration-none text-dark" title="View {{ receipt.original_filename }}">
                        {{ receipt.original_filename|truncatechars:15 }}
                      </a>
                      <form method="post" action="{% url 'reimbursements:receipt_delete' reimbursement.pk item.pk receipt.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn-close btn-sm" style="font-size: 0.5rem;" title="Remove"></button>
                      </form>
                    </span>
                    {% empty %}
                    <form method="post" action="{% url 'reimbursements:receipt_upload' reimbursement.pk item.pk %}" enctype="multipart/form-data" class="d-inline">
                      {% csrf_token %}
                      <label class="btn btn-sm btn-outline-secondary">
                        <input type="file" name="file" class="d-none" onchange="this.form.submit()">
                        Upload
                      </label>
                    </form>
                    {% endfor %}
                    {% if item.receipts.exists %}
                    <form method="post" action="{% url 'reimbursements:receipt_upload' reimbursement.pk item.pk %}" enctype="multipart/form-data" class="d-inline">
                      {% csrf_token %}
                      <label class="btn btn-sm btn-link p-0" title="Add another receipt">
                        <input type="file" name="file" class="d-none" onchange="this.form.submit()">
                        +
                      </label>
                    </form>
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" action="{% url 'reimbursements:expense_delete' reimbursement.pk item.pk %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove this expense?')">
                        Remove
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="3" class="text-end"><strong>Total:</strong></td>
                  <td class="text-end"><strong>${{ reimbursement.calculate_total_requested|floatformat:2 }}</strong></td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5 text-muted">
            <p class="mb-2">No expenses added yet.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
              + Add Your First Expense
            </button>
          </div>
          {% endif %}
        </div>
      </div>

      {# Request Details Form #}
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {# Tax & Payment Info #}
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Tax & Payment Information</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Tax Status</label>
                {{ form.tax_status }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Payment Method</label>
                <div>
                  {% for radio in form.payment_method %}
                  <div class="form-check form-check-inline">
                    {{ radio.tag }}
                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                      {{ radio.choice_label }}
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            {# Check Fields #}
            <div id="check-fields" class="mt-3 {% if reimbursement.payment_method != 'check' %}d-none{% endif %}">
              <label class="form-label">Mailing Address</label>
              {{ form.payment_address }}
            </div>

            {# ACH Fields #}
            <div id="ach-fields" class="mt-3 {% if reimbursement.payment_method != 'ach' %}d-none{% endif %}">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Bank Name</label>
                  {{ form.bank_name }}
                </div>
                <div class="col-md-4">
                  <label class="form-label">Routing Number</label>
                  {{ form.bank_routing_number }}
                </div>
                <div class="col-md-4">
                  <label class="form-label">Account Number</label>
                  {{ form.bank_account_number }}
                </div>
                <div class="col-md-4">
                  <label class="form-label">Account Type</label>
                  {{ form.bank_account_type }}
                </div>
              </div>
            </div>
          </div>
        </div>

        {# Visa Info (conditional) #}
        <div id="visa-fields" class="card mb-4 {% if not reimbursement.requires_visa_docs %}d-none{% endif %}">
          <div class="card-header">
            <h5 class="mb-0">Visa Holder Information</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Country of Citizenship</label>
                {{ form.citizenship_country }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Visa Type</label>
                {{ form.visa_type }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Passport Number</label>
                {{ form.passport_number }}
              </div>
              <div class="col-md-6">
                <label class="form-label">US Entry Date</label>
                {{ form.us_entry_date }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Passport Copy</label>
                {{ form.passport_copy }}
                {% if reimbursement.passport_copy %}
                <div class="form-text">Current: {{ reimbursement.passport_copy.name }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">I-94 Document (Optional)</label>
                {{ form.i94_document }}
                {% if reimbursement.i94_document %}
                <div class="form-text">Current: {{ reimbursement.i94_document.name }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {# Notes #}
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Notes (Optional)</h5>
          </div>
          <div class="card-body">
            {{ form.submitter_notes }}
          </div>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-secondary">Save Changes</button>
          <a href="{% url 'reimbursements:submit' reimbursement.pk %}" class="btn btn-primary">
            Review & Submit
          </a>
        </div>
      </form>
    </div>

    {# Sidebar #}
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Summary</h5>
        </div>
        <div class="card-body">
          <dl class="mb-0">
            <dt>Payee</dt>
            <dd>{{ reimbursement.person }}</dd>
            <dt>Status</dt>
            <dd>{{ reimbursement.get_status_display }}</dd>
            <dt>Total Expenses</dt>
            <dd class="h4">${{ reimbursement.calculate_total_requested|floatformat:2 }}</dd>
          </dl>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          <a href="{% url 'reimbursements:submit' reimbursement.pk %}" class="btn btn-primary w-100 mb-2">
            Review & Submit
          </a>
          <form method="post" action="{% url 'reimbursements:cancel' reimbursement.pk %}">
            {% csrf_token %}
            <input type="hidden" name="reason" value="Cancelled by user">
            <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Are you sure you want to cancel this reimbursement request?')">
              Cancel Request
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{# Add Expense Modal #}
<div class="modal fade" id="addExpenseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'reimbursements:expense_add' reimbursement.pk %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Category</label>
            {{ expense_form.category }}
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            {{ expense_form.description }}
          </div>
          <div class="mb-3">
            <label class="form-label">Date Incurred</label>
            {{ expense_form.date_incurred }}
          </div>
          <div class="mb-3">
            <label class="form-label">Amount (USD)</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              {{ expense_form.amount_requested }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Expense</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Payment method toggle
  const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
  const checkFields = document.getElementById('check-fields');
  const achFields = document.getElementById('ach-fields');

  paymentRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.value === 'check') {
        checkFields.classList.remove('d-none');
        achFields.classList.add('d-none');
      } else {
        checkFields.classList.add('d-none');
        achFields.classList.remove('d-none');
      }
    });
  });

  // Tax status toggle for visa fields
  const taxSelect = document.getElementById('id_tax_status');
  const visaFields = document.getElementById('visa-fields');

  if (taxSelect && visaFields) {
    taxSelect.addEventListener('change', function() {
      if (this.value === 'visa_resident' || this.value === 'visa_nonresident') {
        visaFields.classList.remove('d-none');
      } else {
        visaFields.classList.add('d-none');
      }
    });
  }
});
</script>
{% endblock %}
